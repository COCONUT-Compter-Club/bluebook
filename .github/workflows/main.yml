name: CI/CD for COCONUT Bluebook

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # Checkout repositori
      - name: Checkout code
        uses: actions/checkout@v4

      # Bersihkan cache dan build
      - name: Clean workspace
        run: |
          rm -rf .cache build

      # Build dengan Antora
      - name: Build with Antora
        run: |
          docker run -u $(id -u) \
                 -v $PWD:/antora:Z \
                 --rm -t antora/antora:3.1.2 \
                 --cache-dir=./.cache \
                 --stacktrace \
                 antora-playbook.yml

      # Validasi hasil build
      - name: Validate build output
        run: |
          echo "Build structure:"
          ls -lR build/
          
          if [ -f "build/index.html" ] && [ -d "build/bluebook/draft" ]; then
            echo "‚úÖ Build validation passed"
          else
            echo "‚ùå Error: Invalid build structure"
            exit 1
          fi

      # Simpan build sebagai artefak
      - name: Archive build
        uses: actions/upload-artifact@v4
        with:
          name: bluebook-build
          path: build/
          retention-days: 1

      # Setup SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      # Test koneksi SSH
      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no \
              -p ${{ secrets.VPS_SSH_PORT }} \
              ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} \
              "echo 'SSH connection successful'"

      # Deploy menggunakan Rsync (VERSI DIPERBAIKI)
      - name: Deploy with Rsync
        run: |
          echo "Installing rsync..."
          sudo apt-get update && sudo apt-get install -y rsync
          
          echo "Syncing build directory..."
          rsync -avz --delete \
            -e "ssh -p ${{ secrets.VPS_SSH_PORT }} -o StrictHostKeyChecking=no" \
            build/ \
            ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/home/gusdur/bluebook-coconut/build/
          
          echo "Verifying transfer..."
          ssh -p ${{ secrets.VPS_SSH_PORT }} \
              ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} \
              "ls -l /home/gusdur/bluebook-coconut/build/bluebook/draft/"

      # Final deployment steps
      - name: Finalize deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          script: |
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S rm -rf /var/www/html/build
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S cp -r /home/gusdur/bluebook-coconut/build /var/www/html/
            
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S chown -R www-data:www-data /var/www/html/build
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S find /var/www/html/build -type d -exec chmod 755 {} \;
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S find /var/www/html/build -type f -exec chmod 644 {} \;
            
            if [ -f "/var/www/html/build/bluebook/draft/coconut-draft-inesa.html" ]; then
              echo "‚úÖ Deployment successful"
              echo "üåê Access at: http://${{ secrets.VPS_HOST }}/build"
            else
              echo "‚ùå Deployment failed - missing critical files"
              exit 1
            fi
            
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S nginx -t && echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S systemctl reload nginx
                  
